<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            "50": "#eff6ff",
                            "100": "#dbeafe",
                            "200": "#bfdbfe",
                            "300": "#93c5fd",
                            "400": "#60a5fa",
                            "500": "#3b82f6",
                            "600": "#2563eb",
                            "700": "#1d4ed8",
                            "800": "#1e40af",
                            "900": "#1e3a8a",
                            "950": "#172554"
                        }
                    }
                }
            }
        }
    </script>
    <!-- Drag and Drop Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        .task-card.dragging {
            opacity: 0.5;
        }

        .column-drop-zone {
            min-height: 10px;
        }

        .task-list {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            border: 2px dashed #e5e7eb;
            border-radius: 0.5rem;
            margin: 0.5rem;
        }

        .task-list:not(:empty) {
            border: none;
            margin: 0;
        }

        .task-list:empty {
            min-height: 200px;
        }

        .view-kanban {
            display: none;
        }

        .view-table {
            display: none;
        }

        .active-view {
            display: block;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: #10B981;
        }

        .notification.error {
            background-color: #EF4444;
        }

        .notification.info {
            background-color: #3B82F6;
        }

        /* Loading spinner styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .loading-spinner svg {
            width: 3rem;
            height: 3rem;
        }

        .loading-text {
            color: #2563eb;
            font-weight: 500;
        }

        /* Add border to three dots menu dropdown */
        .task-menu-dropdown {
            border: 1px solid #e5e7eb; /* Tailwind's border-gray-200 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans">
    <!-- Add notification container -->
    <div id="notification-container"></div>

    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Task Management</h1>
                <div class="flex items-center space-x-3">
                    <!-- View Switching Buttons -->
                    <div class="inline-flex rounded-lg border border-gray-200 shadow-sm">
                        <button type="button" id="kanban-view-btn" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-l-lg hover:bg-primary-700 focus:z-10 focus:ring-2 focus:ring-primary-500 transition-colors duration-200">
                            <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                            </svg>
                            Kanban
                        </button>
                        <button type="button" id="table-view-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-r-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-gray-200 transition-colors duration-200">
                            <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            Table
                        </button>
                    </div>
                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-2">
                    <!-- Export Button -->
                        <button type="button" id="export-excel" class="flex items-center justify-center text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-4 py-2 transition-colors duration-200 shadow-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Export to Excel
                    </button>
                        <!-- Refresh Button -->
                        <button type="button" id="refresh-data" class="flex items-center justify-center text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-4 py-2 transition-colors duration-200 shadow-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh Data
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-gray-600">Manage your tasks efficiently with Kanban board or table view</p>
        </header>

        <!-- Kanban View -->
        <div id="kanban-view" class="view-kanban active-view">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Todo Column -->
                <div class="bg-white rounded-lg shadow-md flex-1">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="font-bold text-gray-700 text-lg flex items-center">
                            <span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span>
                            To Do
                            <span class="ml-2 text-gray-500 text-sm task-counter">3</span>
                        </h2>
                        <button id="add-todo" class="flex items-center justify-center text-primary-600 hover:text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-lg px-3 py-1.5 text-sm font-medium transition-colors duration-200">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Task
                        </button>
                    </div>
                    <div class="p-4 task-list" id="todo-column">
                        <!-- Task cards here -->
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="bg-white rounded-lg shadow-md flex-1">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="font-bold text-gray-700 text-lg flex items-center">
                            <span class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>
                            In Progress
                            <span class="ml-2 text-gray-500 text-sm task-counter">2</span>
                        </h2>
                        <button id="add-progress" class="flex items-center justify-center text-primary-600 hover:text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-lg px-3 py-1.5 text-sm font-medium transition-colors duration-200">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Task
                        </button>
                    </div>
                    <div class="p-4 task-list" id="progress-column">
                        <!-- Task cards here -->
                    </div>
                </div>

                <!-- Review Column -->
                <div class="bg-white rounded-lg shadow-md flex-1">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="font-bold text-gray-700 text-lg flex items-center">
                            <span class="w-3 h-3 rounded-full bg-purple-500 mr-2"></span>
                            Review
                            <span class="ml-2 text-gray-500 text-sm task-counter">1</span>
                        </h2>
                        <button id="add-review" class="flex items-center justify-center text-primary-600 hover:text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-lg px-3 py-1.5 text-sm font-medium transition-colors duration-200">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Task
                        </button>
                    </div>
                    <div class="p-4 task-list" id="review-column">
                        <!-- Task cards here -->
                    </div>
                </div>

                <!-- Done Column -->
                <div class="bg-white rounded-lg shadow-md flex-1">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="font-bold text-gray-700 text-lg flex items-center">
                            <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                            Done
                            <span class="ml-2 text-gray-500 text-sm task-counter">2</span>
                        </h2>
                        <button id="add-done" class="flex items-center justify-center text-primary-600 hover:text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-lg px-3 py-1.5 text-sm font-medium transition-colors duration-200">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Task
                        </button>
                    </div>
                    <div class="p-4 task-list" id="done-column">
                        <!-- Task cards here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div id="table-view" class="view-table">
            <div class="bg-white relative shadow-md sm:rounded-lg overflow-visible w-full">
                <div class="flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0 md:space-x-4 p-4">
                    <div class="w-full">
                        <div class="flex items-center space-x-3">
                            <form class="flex-1">
                                <label for="simple-search" class="sr-only">Search</label>
                                <div class="relative w-full">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <svg aria-hidden="true" class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <input type="text" id="simple-search" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 p-2.5" placeholder="Search tasks" required="">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Title</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Description</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Status</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Tag</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Priority</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Assigned User</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Start Date</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Due Date</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Form Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Add New Task</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors p-2 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <form id="task-form">
                <input type="hidden" id="form-column" value="">
                <input type="hidden" id="task-id" value="">
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="task-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" placeholder="Task title" required>
                </div>
                <div class="mb-4">
                    <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="task-description" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" rows="3" placeholder="Task description"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-tag" class="block text-sm font-medium text-gray-700 mb-1">Tag</label>
                        <select id="task-tag" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                            <option value="blue">Feature</option>
                            <option value="purple">Design</option>
                            <option value="yellow">Research</option>
                            <option value="green">Development</option>
                            <option value="red">Bug</option>
                            <option value="indigo">Setup</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="task-priority" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                            <option value="none">None</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="task-assigned-user" class="block text-sm font-medium text-gray-700 mb-1">Assigned User</label>
                    <select id="task-assigned-user" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                        <option value="">Select User</option>
                        <option value="User 1">User 1</option>
                        <option value="User 2">User 2</option>
                        <option value="User 3">User 3</option>
                        <option value="User 4">User 4</option>
                        <option value="User 5">User 5</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="task-start-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="task-due" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" id="task-due" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-task" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <svg aria-hidden="true" class="w-12 h-12 text-gray-200 animate-spin fill-primary-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
            </svg>
            <span class="loading-text">Loading tasks...</span>
        </div>
    </div>

    <script>
        // Function to get the current month's working file name (like table5.html)
        function getCurrentMonthWorkingFile() {
            const now = new Date();
            const month = now.toLocaleString('default', { month: 'long' }).toLowerCase();
            const year = now.getFullYear();
            return `tasks_${month}_${year}.json`;
        }

        // Function to fetch tasks from Confluence (always use tasks.json)
        async function fetchTasks() {
            try {
                const response = await fetch(`https://cedt-confluence.net/confluence/download/attachments/2740868871/tasks.json?api=v2`);
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                return data.tasks || [];
            } catch (error) {
                console.error('Error fetching tasks:', error);
                return [];
            }
        }

        // Function to save tasks to Confluence (always use tasks.json)
        async function saveTasks(tasks) {
            try {
                // Get the attachment ID for tasks.json
                const attachmentsResponse = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment?filename=tasks.json`);
                const attachmentsData = await attachmentsResponse.json();
                if (!attachmentsData.results || attachmentsData.results.length === 0) {
                    throw new Error('tasks.json attachment not found');
                }
                const attachmentId = attachmentsData.results[0].id;
                // Update the existing attachment
                const formData = new FormData();
                const blob = new Blob([JSON.stringify({ tasks }, null, 2)], { type: 'application/json' });
                formData.append('file', blob, 'tasks.json');
                const response = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment/${attachmentId}`, {
                    method: 'POST',
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    },
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Failed to save tasks.json: ${response.status} ${response.statusText}`);
                }
                showNotification('Tasks saved successfully');
                return await response.json();
            } catch (error) {
                console.error('Error saving tasks:', error);
                showNotification('Error saving tasks. Please try again.', 'error');
                throw error;
            }
        }

        // Initialize sortable for each column
        document.addEventListener('DOMContentLoaded', async function () {
            // Load initial tasks
            await loadTasksFromConfluence();

            // Add refresh button functionality
            document.getElementById('refresh-data').addEventListener('click', async function() {
                try {
                    // Show loading overlay
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.add('show');
                    
                    // Clear existing tasks
                    document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
                    
                    // Fetch fresh data from Confluence
                    const tasks = await fetchTasks();
                    
                    if (tasks.length > 0) {
                        // Add tasks to their respective columns
                        tasks.forEach(task => {
                            const column = document.getElementById(`${task.column}-column`);
                            if (column) {
                                const taskCard = document.createElement('div');
                                taskCard.className = 'bg-white rounded p-3 mb-3 shadow-sm border border-gray-200 task-card';
                                taskCard.dataset.id = task.id;
                                taskCard.dataset.priority = task.priority;
                                taskCard.dataset.assignedUser = task.assignedUser;
                                taskCard.dataset.startDate = task.startDate;
                                taskCard.dataset.dueDate = task.dueDate;
                                taskCard.innerHTML = createTaskCardHTML(task);
                                column.appendChild(taskCard);
                            }
                        });
                        
                        // Update UI
                        updateTaskCounters();
                        updateTableView();
                        showNotification('Data refreshed successfully', 'success');
                    } else {
                        showNotification('No tasks found', 'info');
                    }
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    showNotification('Error refreshing data. Please try again.', 'error');
                } finally {
                    // Hide loading overlay
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.remove('show');
                }
            });

            // Function to load tasks from Confluence
            async function loadTasksFromConfluence() {
                try {
                    // Show loading overlay
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.add('show');

                    // Reset all counters to 0 first
                    document.querySelectorAll('.task-counter').forEach(counter => {
                        counter.textContent = '0';
                    });

                    const tasks = await fetchTasks();
                    
                    // Clear existing tasks
                    document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
                    
                    if (tasks.length > 0) {
                        // Add tasks to their respective columns
                        tasks.forEach(task => {
                            const column = document.getElementById(`${task.column}-column`);
                            if (column) {
                                const taskCard = document.createElement('div');
                                taskCard.className = 'bg-white rounded p-3 mb-3 shadow-sm border border-gray-200 task-card';
                                taskCard.dataset.id = task.id;
                                taskCard.dataset.priority = task.priority;
                                taskCard.dataset.assignedUser = task.assignedUser;
                                taskCard.dataset.startDate = task.startDate;
                                taskCard.dataset.dueDate = task.dueDate;
                                taskCard.innerHTML = createTaskCardHTML(task);
                                column.appendChild(taskCard);
                            }
                        });
                        
                        // Update counters and table view only after all tasks are added
                        updateTaskCounters();
                        updateTableView();
                        showNotification('Tasks loaded successfully');
                    } else {
                        showNotification('No tasks found', 'info');
                    }
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    showNotification('Error loading tasks. Please try again.', 'error');
                } finally {
                    // Hide loading overlay
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.remove('show');
                }
            }

            // View switching functionality
            const kanbanView = document.getElementById('kanban-view');
            const tableView = document.getElementById('table-view');
            const kanbanViewBtn = document.getElementById('kanban-view-btn');
            const tableViewBtn = document.getElementById('table-view-btn');
            const searchInput = document.getElementById('simple-search');

            // Add search functionality
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#table-body tr');
                
                rows.forEach(row => {
                    const title = row.querySelector('td:first-child').textContent.toLowerCase();
                    const description = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const status = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const tag = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    const priority = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
                    const assignedUser = row.querySelector('td:nth-child(6)').textContent.toLowerCase();
                    
                    const matches = title.includes(searchTerm) || 
                                  description.includes(searchTerm) || 
                                  status.includes(searchTerm) || 
                                  tag.includes(searchTerm) || 
                                  priority.includes(searchTerm) || 
                                  assignedUser.includes(searchTerm);
                    
                    row.style.display = matches ? '' : 'none';
                });
            });

            function switchView(view) {
                if (view === 'kanban') {
                    kanbanView.classList.add('active-view');
                    tableView.classList.remove('active-view');
                    kanbanViewBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                    kanbanViewBtn.classList.add('bg-primary-600', 'text-white', 'hover:bg-primary-700');
                    tableViewBtn.classList.remove('bg-primary-600', 'text-white', 'hover:bg-primary-700');
                    tableViewBtn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                    showNotification('Switched to Kanban view', 'info');
                } else {
                    tableView.classList.add('active-view');
                    kanbanView.classList.remove('active-view');
                    tableViewBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                    tableViewBtn.classList.add('bg-primary-600', 'text-white', 'hover:bg-primary-700');
                    kanbanViewBtn.classList.remove('bg-primary-600', 'text-white', 'hover:bg-primary-700');
                    kanbanViewBtn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                    updateTableView();
                    showNotification('Switched to Table view', 'info');
                }
            }

            // Initialize view switching
            kanbanViewBtn.addEventListener('click', () => switchView('kanban'));
            tableViewBtn.addEventListener('click', () => switchView('table'));

            // Initial table update
            updateTableView();

            const columns = document.querySelectorAll('.task-list');
            const tagSelect = document.getElementById('task-tag');
            const descriptionTextarea = document.getElementById('task-description');
            const originalDescriptionPlaceholder = descriptionTextarea.placeholder;

            // Add event listener to tag select to update description placeholder
            tagSelect.addEventListener('change', function() {
                if (this.value === 'blue') { // Assuming 'blue' value is for Feature
                    descriptionTextarea.placeholder = 'Describe the task in details or main points...';
                } else {
                    descriptionTextarea.placeholder = originalDescriptionPlaceholder;
                }
            });

            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'bg-gray-100',
                    onEnd: function (evt) {
                        updateTaskCounters();
                        // No need to call updateTableView here, MutationObserver handles it
                    }
                });
            });

            // Update task counters initially
            updateTaskCounters();

            // Add click event listener for task menu buttons
            document.addEventListener('click', async function (e) {
                if (e.target.closest('.task-menu-btn')) {
                    e.stopPropagation();
                    const menuBtn = e.target.closest('.task-menu-btn');
                    const dropdown = menuBtn.nextElementSibling;
                    
                    // Close all other dropdowns
                    document.querySelectorAll('.task-menu-dropdown').forEach(d => {
                        if (d !== dropdown) {
                            d.classList.add('hidden');
                        }
                    });
                    
                    // Toggle current dropdown
                    dropdown.classList.toggle('hidden');
                }
                // Handle edit button clicks
                else if (e.target.closest('.edit-task-card')) {
                    e.stopPropagation();
                    const dropdown = e.target.closest('.task-menu-dropdown');
                    const taskCard = e.target.closest('.task-card') || 
                                   document.querySelector(`.task-card[data-id="${e.target.closest('tr').dataset.taskId}"]`);
                    
                    if (taskCard) {
                        const taskData = {
                            id: taskCard.dataset.id,
                            title: taskCard.querySelector('h3').textContent,
                            description: taskCard.querySelector('p').textContent,
                            tagColor: taskCard.querySelector('span').classList.value.split(' ').find(cls => cls.startsWith('bg-')).replace('bg-', '').replace('-100', ''),
                            tagText: taskCard.querySelector('span').textContent,
                            priority: taskCard.dataset.priority || 'none',
                            assignedUser: taskCard.dataset.assignedUser || '',
                            startDate: taskCard.dataset.startDate || '',
                            dueDate: taskCard.dataset.dueDate || '',
                            column: taskCard.closest('.task-list').id.replace('-column', '')
                        };
                        openEditModal(taskData);
                    }
                    dropdown.classList.add('hidden');
                }
                // Handle delete button clicks
                else if (e.target.closest('.delete-task')) {
                    e.stopPropagation();
                    const dropdown = e.target.closest('.task-menu-dropdown');
                    const taskCard = e.target.closest('.task-card') || 
                                   document.querySelector(`.task-card[data-id="${e.target.closest('tr').dataset.taskId}"]`);
                    
                    if (taskCard && confirm('Are you sure you want to delete this task?')) {
                        try {
                            const taskId = taskCard.dataset.id;
                            
                            // Remove from UI
                            taskCard.remove();
                        const tableRow = document.querySelector(`tr[data-task-id="${taskId}"]`);
                        if (tableRow) {
                            tableRow.remove();
                        }

                            // Save to Confluence
                            const allTasks = Array.from(document.querySelectorAll('.task-card')).map(card => ({
                                id: card.dataset.id,
                                title: card.querySelector('h3').textContent,
                                description: card.querySelector('p').textContent,
                                tagColor: card.querySelector('span').classList.value.split(' ').find(cls => cls.startsWith('bg-')).replace('bg-', '').replace('-100', ''),
                                tagText: card.querySelector('span').textContent,
                                priority: card.dataset.priority,
                                assignedUser: card.dataset.assignedUser,
                                startDate: card.dataset.startDate,
                                dueDate: card.dataset.dueDate,
                                column: card.closest('.task-list').id.replace('-column', '')
                            }));

                            await saveTasks(allTasks);
                            showNotification('Task deleted successfully');
                            updateTaskCounters();
                            updateTableView();
                        } catch (error) {
                            console.error('Error deleting task:', error);
                            showNotification('Error deleting task. Please try again.', 'error');
                        }
                    }
                    dropdown.classList.add('hidden');
                }
                // Close dropdowns when clicking outside
                else {
                    document.querySelectorAll('.task-menu-dropdown').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });
                }
            });

            // Modal functionality
            const modal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const formColumn = document.getElementById('form-column');
            const modalTitle = modal.querySelector('h3');
            const taskTitleInput = document.getElementById('task-title');
            const taskDescriptionTextarea = document.getElementById('task-description');
            const taskTagSelect = document.getElementById('task-tag');
            const taskPrioritySelect = document.getElementById('task-priority');
            const taskAssignedUserSelect = document.getElementById('task-assigned-user');
            const taskStartDateInput = document.getElementById('task-start-date');
            const taskDueDateInput = document.getElementById('task-due');
            const submitButton = taskForm.querySelector('button[type="submit"]');
            const taskIdInput = document.getElementById('task-id');

            // Function to open modal for editing
            function openEditModal(taskData) {
                console.log('Opening edit modal with data:', taskData);
                // Hide all dropdowns before opening modal
                document.querySelectorAll('.task-menu-dropdown').forEach(d => {
                    d.classList.add('hidden');
                });

                taskIdInput.value = taskData.id;
                taskTitleInput.value = taskData.title;
                taskDescriptionTextarea.value = taskData.description;
                taskTagSelect.value = taskData.tagColor;
                taskPrioritySelect.value = taskData.priority;
                taskAssignedUserSelect.value = taskData.assignedUser;
                taskStartDateInput.value = taskData.startDate;
                taskDueDateInput.value = taskData.dueDate;
                formColumn.value = taskData.column;

                modalTitle.textContent = 'Edit Task';
                submitButton.textContent = 'Save Changes';
                // Keep the primary (blue) color for the save button
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-300');
                submitButton.classList.add('bg-primary-600', 'hover:bg-primary-700', 'focus:ring-primary-500');

                // Show the modal
                modal.style.display = 'flex';
                modal.classList.remove('hidden');

                 // Manually trigger change to update description placeholder if needed
                const event = new Event('change');
                taskTagSelect.dispatchEvent(event);
            }

            // Add task buttons
            document.querySelectorAll('[id^="add-"]').forEach(button => {
                button.addEventListener('click', function () {
                    // Hide all dropdowns before opening modal
                    document.querySelectorAll('.task-menu-dropdown').forEach(d => {
                        d.classList.add('hidden');
                    });

                    const columnId = this.id.replace('add-', '');
                    formColumn.value = columnId;
                    // Reset form for adding new task
                    taskForm.reset();
                    taskIdInput.value = ''; // Clear task ID for new task
                    modalTitle.textContent = 'Add New Task';
                    submitButton.textContent = 'Add Task';
                    submitButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-300');
                    submitButton.classList.add('bg-primary-600', 'hover:bg-primary-700', 'focus:ring-primary-500');
                    // Restore original description placeholder
                    descriptionTextarea.placeholder = originalDescriptionPlaceholder;
                    
                    // Show the modal
                    modal.style.display = 'flex';
                    modal.classList.remove('hidden');
                });
            });

            // Function to close modal
            function closeModal() {
                modal.style.display = 'none';
                modal.classList.add('hidden');
                taskForm.reset();
                taskIdInput.value = '';
            }

            // Close modal
            document.getElementById('close-modal').addEventListener('click', closeModal);

            document.getElementById('cancel-task').addEventListener('click', closeModal);

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

             // Function to get priority icon SVG
            function getPriorityIcon(priority) {
                const iconClasses = 'w-4 h-4 mr-1 inline-block';
                switch(priority) {
                    case 'urgent':
                        return `<svg class="${iconClasses} text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l6.082 10.73c.433.764-.066 1.64-.931 1.64H3.347c-.865 0-1.364-.876-.931-1.64L8.257 3.099zM11 8a1 1 0 10-2 0v4a1 1 0 102 0V8zm-1 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>`; // Exclamation triangle
                    case 'high':
                        return `<svg class="${iconClasses} text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 01-8 8v-8H2z"></path><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path></svg>`; // Half circle
                    case 'medium':
                        return `<svg class="${iconClasses} text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`; // Play button in circle
                    case 'low':
                        return `<svg class="${iconClasses} text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM8 14a1 1 0 100-2 1 1 0 000 2zm4-4a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>`; // Three dots in circle
                    case 'none':
                         return `<svg class="${iconClasses} text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`; // Circle with cross
                    default:
                        return '';
                }
            }

            // Submit task form
            taskForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const id = taskIdInput.value || 'task-' + Date.now();
                const taskData = {
                    id,
                    title: taskTitleInput.value,
                    description: taskDescriptionTextarea.value,
                    tagColor: taskTagSelect.value,
                    tagText: taskTagSelect.options[taskTagSelect.selectedIndex].text,
                    startDate: taskStartDateInput.value,
                    dueDate: taskDueDateInput.value,
                    column: formColumn.value,
                    priority: taskPrioritySelect.value,
                    assignedUser: taskAssignedUserSelect.value
                };

                try {
                    // Update UI
                    if (taskIdInput.value) {
                        // Editing existing task
                        const taskCard = document.querySelector(`.task-card[data-id="${id}"]`);
                        if (taskCard) {
                            taskCard.innerHTML = createTaskCardHTML(taskData);
                            updateTaskDataAttributes(taskCard, taskData);
                            
                            // Move card if column changed
                            const currentColumn = taskCard.closest('.task-list').id.replace('-column', '');
                            if (currentColumn !== taskData.column) {
                                document.getElementById(`${taskData.column}-column`).appendChild(taskCard);
                            }
                        }
                    } else {
                        // Adding new task
                        const taskCard = document.createElement('div');
                        taskCard.className = 'bg-white rounded p-3 mb-3 shadow-sm border border-gray-200 task-card';
                        taskCard.dataset.id = id;
                        taskCard.innerHTML = createTaskCardHTML(taskData);
                        updateTaskDataAttributes(taskCard, taskData);
                        document.getElementById(`${taskData.column}-column`).appendChild(taskCard);
                    }

                    // Save to Confluence
                    const allTasks = Array.from(document.querySelectorAll('.task-card')).map(card => ({
                        id: card.dataset.id,
                        title: card.querySelector('h3').textContent,
                        description: card.querySelector('p').textContent,
                        tagColor: card.querySelector('span').classList.value.split(' ').find(cls => cls.startsWith('bg-')).replace('bg-', '').replace('-100', ''),
                        tagText: card.querySelector('span').textContent,
                        priority: card.dataset.priority,
                        assignedUser: card.dataset.assignedUser,
                        startDate: card.dataset.startDate,
                        dueDate: card.dataset.dueDate,
                        column: card.closest('.task-list').id.replace('-column', '')
                    }));

                    await saveTasks(allTasks);

                    // Show success notification after Confluence save
                    if (taskIdInput.value) {
                        showNotification('Task updated successfully');
                    } else {
                        showNotification('Task added successfully');
                    }

                    // Update UI
                    updateTaskCounters();
                    updateTableView();

                    // Close modal and reset form
                    closeModal();
                } catch (error) {
                    console.error('Error saving task:', error);
                    showNotification('Error saving task. Please try again.', 'error');
                    // Close modal even on error
                    closeModal();
                }
            });

            // Helper function to create task card HTML
            function createTaskCardHTML(taskData) {
                const formattedStartDate = taskData.startDate ? new Date(taskData.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                const formattedDueDate = taskData.dueDate ? new Date(taskData.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                const dateRange = (formattedStartDate || formattedDueDate) ? `${formattedStartDate} - ${formattedDueDate}` : '';

                return `
                    <div class="flex justify-between items-start">
                        <span class="bg-${taskData.tagColor}-100 text-${taskData.tagColor}-600 text-xs px-2 py-1 rounded-full">${taskData.tagText}</span>
                        <div class="relative">
                            <button class="text-gray-400 hover:text-gray-600 task-menu-btn">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                </svg>
                            </button>
                            <div class="task-menu-dropdown hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                <div class="py-1">
                                    <button class="edit-task-card w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit</button>
                                    <button class="delete-task w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="font-medium text-gray-800 mt-2">${taskData.title}</h3>
                    <p class="text-sm text-gray-600 mt-1">${taskData.description}</p>
                    <div class="flex items-center mt-2 text-sm text-gray-600">
                        <span class="font-medium mr-1">Priority:</span> ${getPriorityIcon(taskData.priority)}
                        <span class="capitalize">${taskData.priority !== 'none' ? taskData.priority : ''}</span>
                    </div>
                    ${taskData.assignedUser ? `<div class="flex items-center mt-1 text-sm text-gray-600"><span class="font-medium">Assigned:</span> <span class="ml-1">${taskData.assignedUser}</span></div>` : ''}
                    ${dateRange ? `<div class="flex items-center mt-3 text-sm text-gray-600"><span class="font-medium">Dates:</span> <span class="ml-1">${dateRange}</span></div>` : ''}
                `;
            }

            // Helper function to update task card data attributes
            function updateTaskDataAttributes(card, taskData) {
                card.dataset.priority = taskData.priority;
                card.dataset.assignedUser = taskData.assignedUser;
                card.dataset.startDate = taskData.startDate;
                card.dataset.dueDate = taskData.dueDate;
            }

            // Update task counters function
            function updateTaskCounters() {
                document.querySelectorAll('.task-list').forEach(column => {
                    const counter = column.closest('.bg-white').querySelector('.task-counter');
                    const count = column.querySelectorAll('.task-card').length;
                    counter.textContent = count;
                });
            }

            // Update table view with current tasks
            function updateTableView() {
                const tableBody = document.getElementById('table-body');
                if (!tableBody) return; // Guard clause if table body doesn't exist
                
                tableBody.innerHTML = '';

                document.querySelectorAll('.task-card').forEach(card => {
                    const title = card.querySelector('h3').textContent;
                    const description = card.querySelector('p').textContent;
                    const tag = card.querySelector('span').textContent;
                    const dueDateElement = card.querySelector('.text-xs.text-gray-500');
                    const dateRangeText = dueDateElement ? dueDateElement.textContent : '';
                    const dueDate = dateRangeText.includes('-') ? dateRangeText.split('-')[1].trim() : dateRangeText.trim();
                    const status = card.closest('.task-list').id.replace('-column', '').replace(/([A-Z])/g, ' $1').trim();
                    const priority = card.dataset.priority || 'none';
                    const assignedUser = card.dataset.assignedUser || '';
                    const startDate = card.dataset.startDate || '';
                    const rawDueDate = card.dataset.dueDate || '';

                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.dataset.taskId = card.dataset.id;
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${title}</td>
                        <td class="px-4 py-3">${description}</td>
                        <td class="px-4 py-3">
                            <span class="bg-${getStatusColor(status)}-100 text-${getStatusColor(status)}-800 text-xs font-medium px-2.5 py-0.5 rounded">
                                ${status}
                            </span>
                        </td>
                        <td class="px-4 py-3">${tag}</td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                ${getPriorityIcon(priority)}
                                <span class="capitalize">${priority !== 'none' ? priority : ''}</span>
                            </div>
                            </td>
                            <td class="px-4 py-3">${assignedUser}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${startDate}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${rawDueDate || dueDate}</td>
                        <td class="px-4 py-3">
                            <div class="relative">
                                <button class="text-gray-400 hover:text-gray-600 task-menu-btn">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                </svg>
                            </button>
                                <div class="task-menu-dropdown hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                    <div class="py-1">
                                        <button class="edit-task-card w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit</button>
                                        <button class="delete-task w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                 // Add click listeners to rows for editing
                document.querySelectorAll('#table-body tr').forEach(row => {
                    row.addEventListener('click', function(e) {
                        if (e.target.closest('.task-menu-btn')) {
                            e.stopPropagation();
                            const menuBtn = e.target.closest('.task-menu-btn');
                            const dropdown = menuBtn.nextElementSibling;
                            
                            // Close all other dropdowns
                            document.querySelectorAll('.task-menu-dropdown').forEach(d => {
                                if (d !== dropdown) {
                                    d.classList.add('hidden');
                                }
                            });
                            
                            // Toggle current dropdown
                            dropdown.classList.toggle('hidden');
                            return;
                        }

                        if (e.target.closest('.delete-task')) {
                            e.stopPropagation();
                            const taskId = this.dataset.taskId;
                            const taskCard = document.querySelector(`.task-card[data-id="${taskId}"]`);
                            if (taskCard) {
                                taskCard.remove();
                            }
                            this.remove();
                            return;
                        }

                        if (e.target.closest('.edit-task-card')) {
                            e.stopPropagation();
                        const taskId = this.dataset.taskId;
                        const taskCard = document.querySelector(`.task-card[data-id="${taskId}"]`);
                        if (taskCard) {
                             const taskData = {
                                id: taskId,
                                title: taskCard.querySelector('h3').textContent,
                                description: taskCard.querySelector('p').textContent,
                                    tagColor: taskCard.querySelector('span').classList.value.split(' ').find(cls => cls.startsWith('bg-')).replace('bg-', '').replace('-100', ''),
                                priority: taskCard.dataset.priority || 'none',
                                assignedUser: taskCard.dataset.assignedUser || '',
                                startDate: taskCard.dataset.startDate || '',
                                dueDate: taskCard.dataset.dueDate || '',
                                column: taskCard.closest('.task-list').id.replace('-column', '')
                            };
                            openEditModal(taskData);
                            }
                            return;
                        }
                    });
                });
            }

            function getStatusColor(status) {
                const colors = {
                    'todo': 'blue',
                    'progress': 'yellow',
                    'review': 'purple',
                    'done': 'green'
                };
                return colors[status.toLowerCase()] || 'gray';
            }

            // Update table view when tasks are modified
            const observer = new MutationObserver(() => {
                if (document.getElementById('table-view').classList.contains('active-view')) {
                    updateTableView();
                }
            });

            document.querySelectorAll('.task-list').forEach(list => {
                observer.observe(list, { childList: true });
            });

            // Add export to Excel functionality
            document.getElementById('export-excel').addEventListener('click', function() {
                try {
                    // Get all tasks
                    const tasks = Array.from(document.querySelectorAll('.task-card')).map(card => ({
                        Title: card.querySelector('h3').textContent,
                        Description: card.querySelector('p').textContent,
                        Status: card.closest('.task-list').id.replace('-column', '').replace(/([A-Z])/g, ' $1').trim(),
                        Tag: card.querySelector('span').textContent,
                        Priority: card.dataset.priority || 'none',
                        'Assigned User': card.dataset.assignedUser || '',
                        'Start Date': card.dataset.startDate || '',
                        'Due Date': card.dataset.dueDate || ''
                    }));

                    // Create worksheet
                    const ws = XLSX.utils.json_to_sheet(tasks);

                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Tasks");

                    // Generate Excel file
                    const fileName = `tasks_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    showNotification('Tasks exported to Excel successfully');
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    showNotification('Error exporting to Excel. Please try again.', 'error');
                }
            });
        }); // Close main DOMContentLoaded event listener

        // Add notification functions
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Trigger reflow to enable animation
            notification.offsetHeight;
            
            // Show notification
            notification.classList.add('show');
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
